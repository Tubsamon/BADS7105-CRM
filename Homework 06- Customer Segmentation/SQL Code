-- SQL code for customer segmentation in Google Big Query is provided below.
-- Customer Segmentation


CREATE MODEL
    `myfirstproject-312707.TestHW6.TUBSAMON_CLUSTER_3`


OPTIONS
    (
        model_type = 'kmeans',
        num_clusters = 4,
        kmeans_init_method = 'KMEANS++',
        standardize_features = true,
        distance_type = 'euclidean'
    ) 
    
AS
    (
     SELECT 
        
        A.CUST_CODE, 
        TOTAL_VISIT, 
        TOTAL_SPEND, AVG_SPEND,
        AVG_WEEKLY_VISIT, AVG_WEEKLY_SPEND,   
        NO_VISIT_PER_MONTH, TRANSACTION_PER_MONTH, 
        TICKET_SIZE, 
        ARPU_MONTH

        FROM ( 
                SELECT  CUST_CODE,  
                         
                        
                        COUNT(DISTINCT BASKET_ID) AS TOTAL_VISIT,  
                        SUM(SPEND) AS TOTAL_SPEND,  
                        AVG(SPEND) AS AVG_SPEND,
                        COUNT(DISTINCT BASKET_ID)/COUNT(DISTINCT SHOP_WEEK) AS AVG_WEEKLY_VISIT,  
                        SUM(SPEND)/COUNT(DISTINCT SHOP_WEEK) AS AVG_WEEKLY_SPEND,                        
                                        
                        COUNT(DISTINCT BASKET_ID/30)/COUNT(DISTINCT CUST_CODE) AS NO_VISIT_PER_MONTH,  
                        COUNT(DISTINCT(BASKET_ID))/30 AS TRANSACTION_PER_MONTH,  
                        SUM(SPEND)/COUNT(DISTINCT BASKET_ID) AS TICKET_SIZE,                        
                                       
                        ROUND(SUM(SPEND)/COUNT(DISTINCT(ROUND((SHOP_DATE/100),0))),2) AS ARPU_MONTH,    
                

    FROM `myfirstproject-312707.TestHW6.sample_data_table`
    WHERE CUST_CODE IS NOT NULL
    GROUP BY CUST_CODE , SHOP_WEEK) AS A
    )
    
https://user-images.githubusercontent.com/48044778/122065740-61ca8300-ce1c-11eb-913c-c947fbf3fdb9.png
